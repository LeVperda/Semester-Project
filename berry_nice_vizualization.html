<!DOCTYPE html>

<html>

<head>
    <meta />

    <!--styles link-->
    <link rel="stylesheet" href="Berry_styles.css" />

    <!--nav bar link-->
    <!-- This js script needs to be in head of every html for the nav bar to work-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

    <!--Title of the web page-->

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

    <title>Berry nice/showdata</title>
</head>

<body>
    <!--header for the web page-->
    <header>
        <h1>Berry nice</h1>
    </header>

    <div class="hyperlinks">
        <script>
            $(function () {
                $("header").load("berry_navigation.html");
            });
        </script>
    </div>

    <!--class will on full screen-->
    <div class="col-12 col-s-12">
        <!--class will on 1-4 columns of the screen-->
        <div class="col-4 col-s-4">
            <div class="graph_buttons">
                <!--selection for forest developement class-->
                <label for="dev_class">forest_development_class:</label>
                <select name="dev_class" id="dev_class">
                    <option value="all">value</option>
                    <option value="clearing">clearing</option>
                    <option value="seedling">seedling</option>
                    <option value="old">old</option>
                    <option value="plantation">plantation</option>
                </select>
                <br />
                <br />
                <!--selection for main_tree_type-->
                <label for="main_tree_type">Main tree type:</label>
                <select name="main_tree_type" id="main_tree_type">
                    <option value="all">value</option>

                    <option value="birch">birch</option>
                    <option value="spruce">spruce</option>
                    <option value="pine">pine</option>
                    <option value="other">other</option>

                    <option value="swamp">swamp</option>
                    <option value="mixed">mixed</option>
                    <option value="larch">larch</option>
                    <option value="open">open</option>
                </select>
                <br />
                <br />

                <!--selection for date where the time BEGINS-->
                <label>
                    From what date:
                    <input type="date" id="date_from" />
                    <span for="date" class="validity"></span>
                </label>
                <br />
                <br />
                <!--selection for date where the time ENDS-->
                <label>
                    To what date:
                    <input type="date" id="date_to" />
                    <span for="date" class="validity"></span><br />

                    <br />
                    <br />

                    <button onclick="filter()" type="button">Submit</button>
                    <input type="reset" value="reset page" onclick="history.go(0)">
                </label>
            </div>
        </div>

        <div class="col-2 col-s-2">
            <div class="graph_selector">
                <!--selector buttons-->
                <div>
                    <h2>Charts:</h2>

                    <br />
                    barplot: <button onclick="f_barplot()">barplot</button><br />
                    <br />
                    pieplot:<button onclick="f_pieChart()">pieChart</button>
                </div>

            </div>

        </div>

        <div class="col-2 col-s-2">
            <div class="git_notebook">
                <b>here is our notebook for more deeper analyzis</b>
                <br>
                <button id="on_git" onclick="show_on_git()">Submit</button>
            </div>

        </div>

        <div class="col-4 col-s-4">
            <h2 id="all_data" style="text-align: center"></h2>
            <h2 id="filtered_data" style="text-align: center"></h2>
        </div>

        <div class="col-12 col-s-12">
            <div class="col-4 col-s-4">
                <canvas id="barChart" class="charts"></canvas>
            </div>

            <div class="col-4 col-s-4">
                <canvas id="pieChart" class="charts"></canvas>
            </div>



        </div>
        <br>
        <br>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    </div>

    <script>
        Get_data();

        var berries = [];

        var cloudberry = [];
        var lingonberry = [];
        var bilberry = [];

        var xvalues = [];
        var yvalues = [];
        var barColors = [];

        var df = [];
        var filtered_df = [];

        // functio for fetching the data from the api
        function Get_data() {
            // url address
            let url = "http://127.0.0.1:5000/berry_data";

            // fetch the data from backend
            fetch(url)
                .then((Response) => Response.json())
                .then((data) => Show_data(data));
        }

        function Show_data(data) {
            console.log(data);

            // show amount of unfilterd data
            document.getElementById("all_data").innerHTML =
                "amount of data without filtering: " + data.length;

            df = data;

            berry_data_all();
        }

        // function for all the data
        function berry_data_all() {
            for (var key in df) {
                if (df[key].berry == "cloudberry") {
                    cloudberry.push(df[key].berry);
                } else if (df[key].berry == "lingonberry") {
                    lingonberry.push(df[key].berry);
                } else {
                    bilberry.push(df[key].berry);
                }
            }

            xvalues = [`bilberry`, `lingonberry`, `cloudberry`];
            yvalues = [
                bilberry.length,
                lingonberry.length,
                cloudberry.length,
            ];
            barColors = ["blue", "red", "orange"];
        }

        // functio for filtered data
        function berry_data_filtered(filtered_df) {
            // values for the charts
            var cloudberry = [];
            var lingonberry = [];
            var bilberry = [];
            data = filtered_df;

            console.log(filtered_df.length);

            for (var key in data) {
                if (data[key].berry == "cloudberry") {
                    cloudberry.push(data[key].berry);
                } else if (data[key].berry == "lingonberry") {
                    lingonberry.push(data[key].berry);
                } else {
                    bilberry.push(data[key].berry);
                }
            }

            // values for the charts
            xvalues = [`bilberry`, `lingonberry`, `cloudberry`];
            yvalues = [
                bilberry.length,
                lingonberry.length,
                cloudberry.length,
            ];
            barColors = ["blue", "red", "orange"];

            const ctx = document.getElementById("barChart");
        }

        // filtered data
        function filter() {
            console.log("filter")
            filtered_df = df;

            // get the data from option inputs
            forest_development_class =
                document.getElementById("dev_class").value;
            tree_type = document.getElementById("main_tree_type").value;

            // get the data from inserted datetime
            date_time_from = document.getElementById("date_from").value;
            date_time_to = document.getElementById("date_to").value;

            // input datetimes to Time
            const datef = new Date(date_time_from);
            const datet = new Date(date_time_to);

            // if there is no given time, then script doesnt filter the timeline
            if (date_time_from == "" || date_time_to == "") {
                console.log("no time given");
            } else {
                filter_time(datef, datet);
            }

            // if forest developement class is not all, then filter
            if (forest_development_class == "all") {
                console.log("no forestdevelopement given");
            } else {
                filter_developement();
            }

            // if tree type is not all, then filter
            if (tree_type == "all") {
                console.log("tree type not given");
            } else {
                filter_tree_type();
            }

            console.log("------");
            console.log(filtered_df);
            console.log("------");

            berry_data_filtered(filtered_df);

            // show the lenght of filtered data
            if (filtered_df.length != df.length) {
                document.getElementById("filtered_data").innerHTML = "amount filtered data: " + filtered_df.length;
            } else {
                document.getElementById("filtered_data").innerHTML = "";
            }
        }

        // function to filter the tree type
        function filter_tree_type() {
            console.log("made this far");

            filtered_df = filtered_df.filter(
                (el) => el.main_tree_type == tree_type
            );
        }

        // function to filter with the forest developement class
        function filter_developement() {
            console.log(forest_development_class);

            filtered_df = filtered_df.filter(
                (el) =>
                    el.forest_development_class == forest_development_class
            );
        }

        // function to filter with the time
        function filter_time(datef, datet) {
            filtered_df = df.filter((time) => {
                const date = new Date(time.observation_date);

                if (datef.getTime() > datet.getTime()) {
                    alert("date from cannot be more than date to");
                } else {
                    return (
                        date.getTime() > datef.getTime() &&
                        date.getTime() < datet.getTime()
                    );
                }
            });
        }


        // function for making a barplot
        function f_barplot() {

            console.log(xvalues);
            console.log(yvalues);
            const ctx = document.getElementById("barChart");


            new Chart(ctx, {
                type: "bar",
                data: {
                    labels: xvalues,
                    datasets: [
                        {
                            backgroundColor: barColors,
                            label: "#all berries",
                            data: yvalues,
                        },
                    ],
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                        },
                    },

                },
            });

        }

        // function for making a pieplot
        function f_pieChart() {
            const ctx = document.getElementById("pieChart");

            new Chart(ctx, {
                type: "pie",
                data: {
                    labels: xvalues,
                    datasets: [
                        {
                            backgroundColor: barColors,
                            data: yvalues,
                        },
                    ],
                },
                options: {
                    title: {
                        display: true,
                        text: "all the berry data",
                    },
                },
            });
        }

        // show the git
        function show_on_git() {

            var url = "https://3seaseurope.com/wp-content/uploads/2022/07/1-harold.webp"

            window.open(url, "_blank")


        }
    </script>

    <footer>
        <h2>Some links</h2>
        <ul>
            <li><a href="https://www.lapinamk.fi/">Lapin amk</a></li>
            <li><a href="https://www.rovaniemi.fi/">Rovaniemi city</a></li>
            <li><a href="https://sdgs.un.org/goals">UN - Sustainable goals</a></li>
            <li><a href="https://www.luke.fi/en">Luke</a></li>
            <li><a href="https://www.foreca.fi/">Weather</a></li>
            <li><a href="https://www.visitrovaniemi.fi/">Visit Rovaniemi</a></li>
        </ul>
    </footer>
</body>

</html>